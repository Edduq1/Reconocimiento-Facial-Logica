# üîê Sistema de Reconocimiento Facial

## Resumen R√°pido del Proyecto

- **¬øQu√© es?** Aplicaci√≥n web de autenticaci√≥n por **reconocimiento facial** con validaci√≥n de **posici√≥n**. Backend en **Django** (templates) y base de datos **MySQL** (producci√≥n). En desarrollo, funciona con **SQLite** por defecto.
- **¬øC√≥mo funciona?**
  1) El usuario captura su rostro desde el navegador.
  2) El front env√≠a `email`, `facial_frame` (base64) y `position_data` por `POST` a `/api/login/` o al flujo de registro.
  3) El backend genera/lee embeddings y compara √∫nicamente contra el usuario del email, y valida posici√≥n.
  4) Si ambas validaciones pasan, se crea sesi√≥n y se redirige a `/mantenimiento/`.
- **¬øQu√© hace?**
  - Permite **registro** (m√∫ltiples muestras del rostro) y **login facial** seguro (rostro + posici√≥n aproximada).
  - √Årea de mantenimiento muestra datos del usuario autenticado.
- **Apartados del proyecto**
  - `backend/` Django (templates + APIs minimalistas)
  - `login/` app Django con modelos, vistas, templates y est√°ticos
  - `README.md` esta gu√≠a

## Ejecuci√≥n (pasos m√≠nimos)

1) Entrar al backend y crear entorno virtual (Windows/PowerShell)
```powershell
cd backend
python -m venv env
```

2) Activar entorno virtual
```powershell
.\env\Scripts\activate
```

3) Instalar dependencias
```powershell
pip install -r requirements.txt
```

4) Migraciones
```powershell
python manage.py makemigrations
python manage.py migrate
```

5) Ejecutar servidor
```powershell
python manage.py runserver
```

6) Acceso r√°pido
- Login: http://127.0.0.1:8000/login/
- Registro: http://127.0.0.1:8000/register/

## Base de datos

- En **producci√≥n** trabajamos con **MySQL**. Configurable v√≠a variables de entorno (o `backend/.env`).
- En **desarrollo**, si no defines `DB_ENGINE=mysql`, se usa **SQLite** autom√°ticamente (sin instalaci√≥n extra).

## Estructura del proyecto (resumen)

```
Reconocimiento-VOZ-semi-ProyectoFinal/
‚îú‚îÄ backend/
‚îÇ  ‚îú‚îÄ core/
‚îÇ  ‚îÇ  ‚îú‚îÄ settings.py        # Lee .env y configura DB (MySQL o SQLite)
‚îÇ  ‚îÇ  ‚îî‚îÄ urls.py
‚îÇ  ‚îú‚îÄ login/
‚îÇ  ‚îÇ  ‚îú‚îÄ models/            # Modelo Usuario (embeddings/positions)
‚îÇ  ‚îÇ  ‚îú‚îÄ templates/login/   # login.html, register.html, mantenimiento.html
‚îÇ  ‚îÇ  ‚îú‚îÄ static/js/         # facemesh.js (captura, UX)
‚îÇ  ‚îÇ  ‚îî‚îÄ views/views.py     # register_view, api_login, etc.
‚îÇ  ‚îî‚îÄ requirements.txt
‚îî‚îÄ README.md
```

---

## üìã ¬øQu√© es el proyecto?

Este es un sistema completo de **reconocimiento facial** desarrollado con Django y React que permite a los usuarios registrarse y autenticarse utilizando su rostro como m√©todo de identificaci√≥n biom√©trica.

## üéØ ¬øQu√© funci√≥n tiene?

El sistema implementa dos funcionalidades principales:

### üîë **Autenticaci√≥n Facial**
- **Registro de usuarios:** Captura m√∫ltiples fotos del rostro para crear un perfil biom√©trico √∫nico
- **Login facial:** Autenticaci√≥n mediante reconocimiento facial en tiempo real
- **Sistema de voting:** Utiliza 7 frames con algoritmo de voting para mayor precisi√≥n en el reconocimiento

### üõ°Ô∏è **Seguridad Biom√©trica**
- Procesamiento de embeddings faciales con **Mediapipe**
- Almacenamiento seguro en base de datos **MySQL**
- Integraci√≥n completa con el sistema de autenticaci√≥n de **Django**

## ‚öôÔ∏è ¬øQu√© se hace?

1. **Registro:** El usuario proporciona sus datos personales y toma m√∫ltiples fotos de su rostro
2. **Procesamiento:** El sistema genera embeddings faciales √∫nicos usando Mediapipe
3. **Almacenamiento:** Los datos se guardan en MySQL con relaci√≥n Usuario‚ÜîPersona
4. **Login:** El usuario se posiciona frente a la c√°mara para el reconocimiento
5. **Reconocimiento:** El sistema compara el rostro actual con todos los embeddings almacenados
6. **Autenticaci√≥n:** Si hay match exitoso, el usuario queda autenticado autom√°ticamente

## üîó Rutas de Acceso (Django Templates)

- Login facial (UI): http://127.0.0.1:8000/login/
- Registro facial (UI): http://127.0.0.1:8000/register/
- √Årea de mantenimiento (protegida): http://127.0.0.1:8000/mantenimiento/

APIs usadas por el front (por si deseas probar con Postman):
- POST http://127.0.0.1:8000/api/login/
- POST http://127.0.0.1:8000/api/encode/

## ‚öôÔ∏è Ejecuci√≥n R√°pida (Backend Django + Templates)

1. Activar entorno virtual (Windows PowerShell):
   ```powershell
   .\backend\env\Scripts\Activate.ps1
   ```
2. Instalar dependencias:
   ```powershell
   pip install -r backend\requirements.txt
   ```
3. Exportar variables para usar MySQL (credenciales solicitadas):
   ```powershell
   $env:DB_ENGINE="mysql"; $env:MYSQL_DATABASE="app_db"; $env:MYSQL_USER="root"; $env:MYSQL_PASSWORD="mysql"; $env:MYSQL_HOST="127.0.0.1"; $env:MYSQL_PORT="3306"
   ```
4. Migraciones (ejecutar desde carpeta backend) y superusuario (OPCIONAL solo para entrar al admin):
   ```powershell
   python manage.py makemigrations
   python manage.py migrate
   # Solo si deseas entrar al panel de administraci√≥n Django:
   # python manage.py createsuperuser
   ```
5. Ejecutar servidor:
   ```powershell
   python manage.py runserver
   ```
6. Navega a:
   - Login: http://127.0.0.1:8000/login/
   - Registro: http://127.0.0.1:8000/register/

Notas:
- La malla de puntos/l√≠neas se dibuja en color blanco y se adapta al rostro en tiempo real.
- La posici√≥n 3D relativa se valida mediante `{x, y, scale}` para mitigar suplantaci√≥n por distancia/encuadre. Se puede extender a roll/pitch/yaw si lo requieres.

---

## üîå Endpoints para Postman

### üìù **Endpoint de Registro**

**POST** `http://localhost:8000/api/reconocimiento/register/`

**Headers:**
```
Content-Type: application/json
```

**Body (JSON):**
```json
{
    "username": "juan_perez",
    "email": "juan@email.com",
    "dni": "12345678",
    "images": [
        "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...",
        "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...",
        "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ..."
    ]
}
```

**Response (√âxito):**
```json
{
    "status": "ok",
    "person_id": 1,
    "user_id": 1,
    "username": "juan_perez",
    "email": "juan@email.com",
    "dni": "12345678",
    "images_saved": 3,
    "message": "Registro exitoso. Se procesaron 3 im√°genes."
}
```

### üîê **Endpoint de Login Facial**

**POST** `http://localhost:8000/api/reconocimiento/phase1/`

**Headers:**
```
Content-Type: application/json
```

**Body (JSON):**
```json
{
    "frames": [
        {
            "image_data": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...",
            "timestamp": 1640995200000,
            "frame_number": 1
        },
        {
            "image_data": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...",
            "timestamp": 1640995200500,
            "frame_number": 2
        },
        {
            "image_data": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...",
            "timestamp": 1640995201000,
            "frame_number": 3
        },
        {
            "image_data": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...",
            "timestamp": 1640995201500,
            "frame_number": 4
        },
        {
            "image_data": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...",
            "timestamp": 1640995202000,
            "frame_number": 5
        },
        {
            "image_data": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...",
            "timestamp": 1640995202500,
            "frame_number": 6
        },
        {
            "image_data": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...",
            "timestamp": 1640995203000,
            "frame_number": 7
        }
    ],
    "user_id": "test_user",
    "session_id": "session_test_123"
}
```

**Response (Reconocimiento Exitoso):**
```json
{
    "status": "ok",
    "matched": true,
    "person_id": 1,
    "score": 0.85,
    "confidence": 0.92,
    "frames_processed": 7,
    "current_attempts": 0,
    "max_attempts": 3,
    "message": "¬°Bienvenido juan_perez! Reconocimiento exitoso.",
    "username": "juan_perez"
}
```

**Response (Reconocimiento Fallido):**
```json
{
    "status": "ok",
    "matched": false,
    "person_id": null,
    "score": 0.45,
    "confidence": 0.52,
    "frames_processed": 7,
    "current_attempts": 1,
    "max_attempts": 3,
    "message": "No se pudo verificar tu identidad. Verifica la iluminaci√≥n y posici√≥n del rostro."
}
```

## üöÄ C√≥mo ejecutar el proyecto

### 1Ô∏è‚É£ **Crear Entorno Virtual**
```bash
python -m venv env
```

### 2Ô∏è‚É£ **Activar Entorno Virtual**
```bash
.\env\Scripts\activate
```

### 3Ô∏è‚É£ **Navegar al Backend**
```bash
cd backend
```

### 4Ô∏è‚É£ **Instalar Dependencias**
```bash
pip install -r requirements.txt
```

### 5Ô∏è‚É£ **Configurar Variables de Entorno**

Copia el archivo `.env.example` y ren√≥mbralo a `.env`:
```bash
copy .env.example .env
```

**üóÑÔ∏è Configuraci√≥n de Base de Datos:**

El proyecto est√° configurado para usar **SQLite por defecto** (no requiere instalaci√≥n adicional).

**Para usar SQLite (Recomendado para desarrollo):**
- No necesitas cambiar nada en el archivo `.env`
- El archivo `db.sqlite3` se crear√° autom√°ticamente

**Para usar MySQL (Opcional):**
1. Instala MySQL en tu sistema
2. Crea una base de datos llamada `reconocimiento_voz_db`
3. Edita el archivo `.env` y cambia:
   ```
   DB_ENGINE=mysql
   DB_NAME=reconocimiento_voz_db
   DB_USER=tu_usuario_mysql
   DB_PASSWORD=tu_password_mysql
   ```

### 6Ô∏è‚É£ **Crear Migraciones**
```bash
python manage.py makemigrations
```

### 7Ô∏è‚É£ **Aplicar Migraciones**
```bash
python manage.py migrate
```

### 8Ô∏è‚É£ **Ejecutar Servidor Backend**
```bash
python manage.py runserver
```

### 9Ô∏è‚É£ **Configurar Frontend (Opcional)**

Si quieres ejecutar tambi√©n el frontend React:

1. **Abrir nueva terminal** y navegar al frontend:
```bash
cd frontend
```

2. **Instalar dependencias de Node.js:**
```bash
npm install
```

3. **Ejecutar servidor de desarrollo:**
```bash
npm run dev
```

### ‚úÖ **¬°Listo!**
- **Backend:** `http://127.0.0.1:8000/`
- **Frontend:** `http://localhost:5173/` (si ejecutaste el frontend)

---

**üéØ Sistema desarrollado con Django + MySQL + Mediapipe para reconocimiento facial biom√©trico**
